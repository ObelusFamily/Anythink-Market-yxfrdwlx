version: v1
kind: kubernetes
application: Anythink
targets: 
  staging:
    account: prod
    namespace: anythink-market-yxfrdwlx
    strategy: bluelake
    constraints:
      afterDeployment:
      - runWebhook:
          name: Notify_Wilco_Completion
          context:
            environment: staging
            
manifests:  
  - path: manifests/anythink.yml
  
trafficManagement:
  - targets: [prod-eu]
    kubernetes:
      - activeService: anythink-backend
      - activeService: anythink-frontend
      - activeService: postgres-python
      
strategies: 
  bluelake:
    bluegreen:
      redirectTrafficAfter:
        - pause:
            untilApproved: true
      shutDownOldVersionAfter:
        - pause:
            untilApproved: true
  rolling:
    canary:
      steps: 
      - setWeight:
          weight: 100
webhooks: 
#https://engine.wilco.gg/users/{{secrets.WILCO_ID}}/event
#'{ "event": "armory_webhook", "payload": {...} }'
  - name: Notify_Wilco_Completion
    method: POST
    uriTemplate: https://engine.wilco.gg/users/${{WILCO_ID}}/event
    # uriTemplate: https://api.github.com/repos/{{secrets.github_org}}/{{secrets.github_repository}}/dispatches
    #headers:
    #  - key: Authorization
    #    value: token {{secrets.github_token}}
    #  - key: Content-Type
    #    value: application/json
    bodyTemplate:
      inline:  >-
        {
        "event": "armory_webhook",
        "payload": {
            "callbackUri": "{{armory.callbackUri}}/callback"
            "environment": "{{context.environment}}"
            }
        }
    #bodyTemplate:
    #  inline:  >-
    #    {
    #    "event_type": "checkLogs",
    #    "client_payload": {
    #        "callbackUri": "{{armory.callbackUri}}/callback"
    #        }
    #    }
    #
    retryCount: 3
    disableCallback: true
